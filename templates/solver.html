<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>航班调度求解与比较</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            padding-top: 20px;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1200px;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }
        .result-section {
            display: none; /* 初始隐藏 */
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            background-color: #fdfdfd;
        }
        .loading-spinner {
            display: none; /* 初始隐藏 */
            text-align: center;
            padding: 20px;
        }
        .loading-spinner .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        /* 针对 iframe 的样式 */
        .result-iframe {
            width: 100%;
            height: 500px; /* 根据需要调整高度 */
            border: 1px solid #ddd;
            border-radius: 5px;
            display: block;
            margin: 20px auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4 text-center">
            <i class="fas fa-plane-departure"></i> 航班调度求解结果分析
        </h1>

        <!-- 算例选项区 -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-cogs"></i> 选择算例</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="caseSelect" class="form-label">请选择一个算例进行分析：</label>
                    <select class="form-select" id="caseSelect">
                        <option value="0606">算例一：06月06日</option>
                        <option value="0623">算例二：06月23日</option>
                        <option value="0703">算例三：07月03日</option>
                        <option value="0711">算例四：07月11日</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- 按钮区 -->
        <div class="text-center mb-5">
            <button id="singleBaseBtn" class="btn btn-info btn-lg me-3">
                <i class="fas fa-sitemap"></i> 单基地求解
            </button>
            <button id="multiBaseBtn" class="btn btn-success btn-lg">
                <i class="fas fa-project-diagram"></i> 多基地求解
            </button>
        </div>

        <!-- 加载指示器 -->
        <div id="loadingSpinner" class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <p class="mt-2">正在加载结果，请稍候...</p>
        </div>

        <!-- 结果图示区 -->
        <div id="resultGraphicsSection" class="result-section">
            <h3 class="mb-4 text-center"><i class="fas fa-chart-bar"></i> 求解结果示意图</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-3">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">单基地求解示意图</h6>
                        </div>
                        <div class="card-body text-center">
                            <!-- 使用 iframe 嵌入 -->
                            <iframe id="singleBaseIframe" src="" class="result-iframe" frameborder="0"></iframe>
                            <p class="text-muted mt-2">（图：单基地调度优化结果）</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card mb-3">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">多基地求解示意图</h6>
                        </div>
                        <div class="card-body text-center">
                            <!-- 使用 iframe 嵌入 -->
                            <iframe id="multiBaseIframe" src="" class="result-iframe" frameborder="0"></iframe>
                            <p class="text-muted mt-2">（图：多基地协同优化结果）</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 结果比较表格区 -->
        <div id="resultTableSection" class="result-section">
            <h3 class="mb-4 text-center"><i class="fas fa-table"></i> 结果比较</h3>
            <div class="table-responsive">
                <table class="table table-striped table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th>指标</th>
                            <th>单基地求解结果</th>
                            <th>多基地求解结果</th>
                        </tr>
                    </thead>
                    <tbody id="comparisonTableBody">
                        <!-- 修改这里的行以匹配新的指标 -->
                        <tr><td>飞行值勤日均时</td><td id="singleAvgDutyTime"></td><td id="multiAvgDutyTime"></td></tr>
                        <tr><td>未覆盖航班数量</td><td id="singleUncoveredFlights"></td><td id="multiUncoveredFlights"></td></tr>
                        <tr><td>外站过夜天数</td><td id="singleLayoverDays"></td><td id="multiLayoverDays"></td></tr>
                        <tr><td>新增过夜机场数量</td><td id="singleNewLayoverAirports"></td><td id="multiNewLayoverAirports"></td></tr>
                        <tr><td>置位次数</td><td id="singlePlacementTimes"></td><td id="multiPlacementTimes"></td></tr>
                        <tr><td>违规次数</td><td id="singleViolationTimes"></td><td id="multiViolationTimes"></td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="text-center mt-5">
            <p class="text-muted">© 2023 航班调度分析系统</p>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        $(document).ready(function() {
            // 事件绑定
            $('#singleBaseBtn').click(function() {
                loadAndDisplayResults('single');
            });

            $('#multiBaseBtn').click(function() {
                loadAndDisplayResults('multi');
            });

            function loadAndDisplayResults(solveType) {
                const selectedCase = $('#caseSelect').val();
                
                // 1. 隐藏旧结果，显示加载动画
                $('#resultGraphicsSection').hide();
                $('#resultTableSection').hide();
                $('#loadingSpinner').show();

                // 2. 发送AJAX请求获取数据和iframe的URL
                $.ajax({
                    url: '/api/solve_schedule', 
                    type: 'GET',
                    data: { 
                        case: selectedCase, 
                        type: solveType 
                    },
                    success: function(response) {
                        // 隐藏加载动画
                        $('#loadingSpinner').hide();
                        
                        if (response.single_base_iframe_url && response.multi_base_iframe_url) {
                            $('#singleBaseIframe').attr('src', response.single_base_iframe_url);
                            $('#multiBaseIframe').attr('src', response.multi_base_iframe_url);
                            $('#resultGraphicsSection').show(); // 显示图片区
                        } else {
                            console.error("iframe URL缺失");
                            alert('加载数据失败：iframe URL缺失'); 
                        }

                        if (response.comparison_data) {
                            // !!! 关键改动：更新比较表格的JS逻辑 !!!
                            // 单基地数据
                            $('#singleAvgDutyTime').text(response.comparison_data.single.total_duty_time);
                            $('#singleUncoveredFlights').text(response.comparison_data.single.uncovered_flights_rate);
                            $('#singlePlacementTimes').text(response.comparison_data.single.placement_times);
                            $('#singleLayoverDays').text(response.comparison_data.single.layover_days);
                            $('#singleNewLayoverAirports').text(response.comparison_data.single.new_layover_airports);
                            $('#singleViolationTimes').text(response.comparison_data.single.violation_times);

                            // 多基地数据
                            $('#multiAvgDutyTime').text(response.comparison_data.multi.total_duty_time);
                            $('#multiUncoveredFlights').text(response.comparison_data.multi.uncovered_flights_rate);
                            $('#multiPlacementTimes').text(response.comparison_data.multi.placement_times);
                            $('#multiLayoverDays').text(response.comparison_data.multi.layover_days);
                            $('#multiNewLayoverAirports').text(response.comparison_data.multi.new_layover_airports);
                            $('#multiViolationTimes').text(response.comparison_data.multi.violation_times);

                            $('#resultTableSection').show(); // 显示表格区
                        } else {
                            console.error("比较数据缺失");
                            alert('加载数据失败：比较数据缺失'); 
                        }
                    },
                    error: function(xhr, status, error) {
                        $('#loadingSpinner').hide();
                        let errorMessage = '加载数据失败。';
                        if (xhr.status === 0) {
                            errorMessage += '请检查后端服务是否已启动，以及网络连接。';
                        } else if (xhr.status === 404) {
                             errorMessage += 'API地址未找到 (404)。请确认后端路由 `/api/solve_schedule` 是否正确。';
                        } else if (xhr.status === 400) {
                             errorMessage += '请求参数错误 (400)。请检查算例选择。';
                        } else if (xhr.responseText) {
                            try {
                                const errJson = JSON.parse(xhr.responseText);
                                errorMessage += `错误信息: ${errJson.error || xhr.responseText}`;
                            } catch (e) {
                                errorMessage += `原始错误: ${xhr.responseText}`;
                            }
                        } else {
                            errorMessage += `状态: ${status}, 错误: ${error}`;
                        }
                        alert(errorMessage);
                        console.error('AJAX Error:', status, error, xhr);
                    }
                });
            }
        });
    </script>
</body>
</html>